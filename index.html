<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>ISBN Scanner + Supabase Login (v2)</title>
  <style>
    :root { --gap: 12px; }
    body{font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Hiragino Sans", "Noto Sans JP", "Yu Gothic UI", "Yu Gothic", "游ゴシック", "Meiryo", sans-serif; margin: 16px;}
    header{margin-bottom: var(--gap);}
    video{width:100%;max-width:560px;border:1px solid #e5e5e5;border-radius:8px;background:#000}
    .row{margin: var(--gap) 0;}
    .small{opacity:.9;font-size:.9rem}
    select,button,input{font-size:1rem;padding:.5rem .7rem;border:1px solid #ccc;border-radius:8px}
    #result{font-weight:700}
    #status{margin-top:6px; font-size:.9rem; color:#555;}
    #book{margin-top: 16px; display:none}
    #book img{max-height: 140px; border-radius:8px; border: 1px solid #eee}
    #book .meta{margin-left: 12px}
    .flex{display:flex; align-items:flex-start; gap:12px; flex-wrap:wrap}
    .muted{color:#777}
    .hint{margin-top:8px;color:#666;font-size:.9rem}
    .card{border:1px solid #eee;border-radius:8px;padding:12px}
  </style>
</head>
<body>
<header>
  <h1>ISBN スキャナ + Googleログイン <small style="font-size:.65em;color:#777;">v2</small></h1>
  <p class="small">①Googleログイン → ②カメラでバーコード（ISBN-13/EAN-13）を読み取り → ③n8n Webhook に送信</p>
  <p class="hint">ヒント：本の裏側にバーコードが2つある場合、<b>978/979で始まる方がISBN</b>です（価格用コードは無視します）。</p>
</header>

<div class="card">
  <div class="row">
    <button id="btn-login">Googleでログイン</button>
    <button id="btn-logout" style="display:none;">ログアウト</button>
  </div>
  <div class="row small">
    <div>ログイン状態: <span id="who">未ログイン</span></div>
  </div>
</div>

<div class="row">
  <button id="start">カメラ起動</button>
  <select id="devices" aria-label="カメラ選択"></select>
  <label class="small"><input type="checkbox" id="torch"> ライト</label>
  <label class="small" style="margin-left:8px;">
    <input type="checkbox" id="labBook"> これはゼミ室の本
  </label>
</div>

<video id="preview" playsinline muted></video>
<div id="status" class="muted">未起動</div>

<div class="row">
  <label>検出結果: </label><span id="result">—</span>
</div>

<div id="book" class="flex">
  <img id="cover" alt="cover">
  <div class="meta">
    <div id="title"></div>
    <div id="authors" class="muted"></div>
    <div id="rec"></div>
  </div>
</div>

<script src="https://unpkg.com/@supabase/supabase-js@2"></script>
<script type="module">
  import { BrowserMultiFormatReader, NotFoundException } from "https://cdn.jsdelivr.net/npm/@zxing/library@0.20.0/+esm";

  // ====== 設定：以下2つをSupabaseとn8nに合わせて書き換え ======
  const SUPABASE_URL = "https://YOUR-PROJECT.supabase.co";      // ←SupabaseのProject URL
  const SUPABASE_ANON_KEY = "YOUR-ANON-PUBLIC-KEY";              // ←SupabaseのAnon公開キー
  const N8N_WEBHOOK_URL = "https://YOUR-N8N-DOMAIN/webhook/scan";// ←n8nのWebhook URL
  // ============================================================

  const supa = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  const codeReader = new BrowserMultiFormatReader();
  const video = document.getElementById('preview');
  const devicesSel = document.getElementById('devices');
  const startBtn = document.getElementById('start');
  const statusEl = document.getElementById('status');
  const torchEl = document.getElementById('torch');
  const labBookEl = document.getElementById('labBook');
  const resultEl = document.getElementById('result');
  const whoEl = document.getElementById('who');
  const loginBtn = document.getElementById('btn-login');
  const logoutBtn = document.getElementById('btn-logout');

  const bookBox = document.getElementById('book');
  const coverEl = document.getElementById('cover');
  const titleEl = document.getElementById('title');
  const authorsEl = document.getElementById('authors');
  const recEl = document.getElementById('rec');

  let lastScan = { code: null, at: 0 };

  // ====== ISBNユーティリティ ======
  function isValidIsbn13(s){
    if(!/^\d{13}$/.test(s)) return false;
    const digits = s.split('').map(Number);
    const sum = digits.slice(0,12).reduce((acc, d, i)=> acc + d * (i%2 ? 3 : 1), 0);
    const check = (10 - (sum % 10)) % 10;
    return check === digits[12];
  }
  function normalizeCandidate(raw){
    let t = (raw||'').replace(/\D/g,'');
    if (t.length > 13 && t.startsWith('97') && /^\d{18}$/.test(t)) {
      t = t.slice(0,13);
    }
    return t;
  }
  function looksLikeIsbn13(s){
    return (s.startsWith('978') || s.startsWith('979')) && isValidIsbn13(s);
  }

  async function listCameras(){
    const devices = await navigator.mediaDevices.enumerateDevices();
    const cams = devices.filter(d=>d.kind==='videoinput');
    devicesSel.innerHTML = '';
    cams.forEach((c,i)=>{
      const opt=document.createElement('option');
      opt.value=c.deviceId; opt.textContent=c.label||`camera ${i+1}`;
      devicesSel.appendChild(opt);
    });
  }

  async function startCamera(){
    await listCameras();
    const deviceId = devicesSel.value || undefined;
    statusEl.textContent = "スキャン中…";
    try {
      codeReader.decodeFromVideoDevice(deviceId, video, onScan);
    } catch (e) {
      console.error(e);
      statusEl.textContent = "起動エラー: " + e.message;
    }
  }

  function debounceDuplicate(code, ms=3000){
    const now = Date.now();
    if (lastScan.code === code && (now - lastScan.at) < ms) return true;
    lastScan = { code, at: now };
    return false;
  }

  async function onScan(res, err){
    if(res){
      const raw = res.getText();
      const cand = normalizeCandidate(raw);

      // 二本バーコード対策：ISBN(978/979)かつチェックデジットOKだけ採用
      if (!looksLikeIsbn13(cand)) {
        return;
      }
      if (debounceDuplicate(cand)) return;

      resultEl.textContent = cand; // 表示はISBNのみ

      // ログインユーザーからアクセストークン取得（n8nで検証する）
      const { data: sess } = await supa.auth.getSession();
      const accessToken = sess?.session?.access_token || null;
      const userId = sess?.session?.user?.id || null;

      if (!accessToken || !userId){
        statusEl.textContent = "ログインしてからスキャンしてください。";
        return;
      }

      const payload = {
        isbn: cand,
        userId,
        isLabBook: !!labBookEl.checked,
        supabaseAccessToken: accessToken
      };

      try{
        const r = await fetch(N8N_WEBHOOK_URL, {
          method:"POST",
          headers:{ "Content-Type":"application/json" },
          body: JSON.stringify(payload)
        });
        if(!r.ok){ throw new Error("n8n error " + r.status); }
        const data = await r.json().catch(()=> ({}));

        if (data && data.book){
          bookBox.style.display = "flex";
          coverEl.src = data.book.cover_url || "";
          titleEl.textContent = `${data.book.title || "タイトル不明"} / ${data.book.isbn13 || ""}`;
          authorsEl.textContent = (data.book.authors || []).join(", ");
          if (Array.isArray(data.recommendations) && data.recommendations.length){
            recEl.innerHTML = "<b>おすすめ:</b> " + data.recommendations.map(x=>x.isbn13).slice(0,5).join(", ");
          } else {
            recEl.textContent = "";
          }
        }
        statusEl.textContent = "送信完了";
      }catch(e){
        console.error(e);
        statusEl.textContent = "送信失敗: " + e.message;
      }
    }else if(err && !(err instanceof NotFoundException)){
      console.warn(err);
    }
  }

  startBtn.addEventListener('click', startCamera);
  devicesSel.addEventListener('change', ()=>{ codeReader.reset(); startCamera(); });

  // Torch (可能な端末のみ)
  torchEl.addEventListener('change', async ()=>{
    try{
      const track = video.srcObject ? video.srcObject.getVideoTracks()[0] : null;
      if(!track) return;
      await track.applyConstraints({ advanced: [{ torch: torchEl.checked }] });
    }catch(e){
      console.log("Torch unsupported", e);
      torchEl.checked = false;
    }
  });

  // ===== ログインUI =====
  async function refreshUser(){
    const { data: { user } } = await supa.auth.getUser();
    if (user){
      whoEl.textContent = user.email || user.id;
      loginBtn.style.display = "none";
      logoutBtn.style.display = "inline-block";
    }else{
      whoEl.textContent = "未ログイン";
      loginBtn.style.display = "inline-block";
      logoutBtn.style.display = "none";
    }
  }
  loginBtn.addEventListener('click', async ()=>{
    await supa.auth.signInWithOAuth({
      provider: 'google',
      options: { redirectTo: location.origin + location.pathname }
    });
  });
  logoutBtn.addEventListener('click', async ()=>{
    await supa.auth.signOut();
    await refreshUser();
  });
  refreshUser();

  if (location.protocol !== 'https:' && location.hostname !== 'localhost') {
    statusEl.textContent = "注意: カメラ使用には https が必要です（localhost除く）";
  }
</script>
</body>
</html>
