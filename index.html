<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Lab Libraryï½œISBNã‚¹ã‚­ãƒ£ãƒŠ</title>
  <style>
    :root{
      --brand:#d33a57;
      --brand-weak:#e8728b;
      --ink:#3b4758;
      --text:#5a6473;
      --muted:#7b8794;
      --panel:#fdeaf0;
      --bg:#fbfcfe;
      --radius-xl:24px;
      --shadow-lg:0 20px 50px rgba(27,39,51,.12);
      --shadow-md:0 10px 30px rgba(27,39,51,.08);
    }
    html,body{height:100%}
    body{
      margin:0; color:var(--text);
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Hiragino Sans", "Noto Sans JP", "Yu Gothic UI", "Yu Gothic", "æ¸¸ã‚´ã‚·ãƒƒã‚¯", "Meiryo", sans-serif;
      background:
        radial-gradient(1200px 600px at 20% -10%, #ffeef4 0%, rgba(255,255,255,0) 60%),
        radial-gradient(1000px 500px at 90% 0%, #eef5ff 0%, rgba(255,255,255,0) 55%),
        var(--bg);
      display:flex; flex-direction:column; align-items:center;
    }
    header{ width:min(920px, 92vw); text-align:center; margin:48px 0 28px; }
    .brand{ display:inline-flex; align-items:center; gap:14px; color:var(--ink); }
    .brand svg{ width:36px; height:36px; color:var(--brand); }
    .brand h1{ font-size:clamp(28px,4.4vw,44px); line-height:1.1; margin:0; letter-spacing:.4px; font-weight:800; }
    .subtitle{ margin-top:8px; color:var(--text); font-size:clamp(14px,1.8vw,18px); }
    .underline{ width:120px; height:6px; margin:20px auto 0; border-radius:999px; background:var(--brand); opacity:.88; }

    .card{
      width:min(860px, 90vw);
      margin:32px auto 0;
      background:var(--panel);
      border-radius:24px;
      box-shadow:var(--shadow-lg);
      padding:28px clamp(18px, 5vw, 40px);
    }
    .card h2{ margin:6px 0 18px; text-align:center; color:var(--ink); font-size:clamp(18px,3vw,24px); letter-spacing:.6px; }
    .field{ margin:14px 0 8px; }
    .label{ display:block; font-weight:700; color:var(--ink); margin:0 0 8px; }
    input[type="text"]{
      width:100%; background:#fff; border:1px solid #e6e8eb; border-radius:12px;
      padding:14px 16px; font-size:16px; outline:none; box-shadow: inset 0 1px 0 rgba(0,0,0,.02);
    }
    input[type="text"]::placeholder{ color:#99a3ad; }

    .btn{
      width:100%; display:inline-flex; align-items:center; justify-content:center; gap:10px;
      margin-top:14px; padding:16px 18px; background:var(--brand-weak); color:#fff;
      border:none; border-radius:16px; font-size:17px; letter-spacing:.6px; cursor:pointer;
      box-shadow:var(--shadow-md); transition: transform .03s ease, filter .2s ease, background .2s ease;
    }
    .btn:hover{ filter:brightness(1.02) }
    .btn:active{ transform:translateY(1px) }
    .btn svg{ width:20px; height:20px }

    .note{ margin:14px 2px 2px; color:var(--muted); display:flex; align-items:flex-start; gap:8px; font-size:14px; }
    .note .dot{ width:8px; height:8px; border-radius:999px; background:var(--brand); margin-top:7px }

    /* ã‚«ãƒ¡ãƒ©è¡¨ç¤ºã‚«ãƒ¼ãƒ‰ */
    .cam-card{
      width:min(860px, 90vw);
      margin:18px auto 0;
      background:#fff; border-radius:16px; box-shadow:var(--shadow-md);
      padding:14px 14px 18px; border:1px solid #e9edf3;
    }
    .cam-head{ display:flex; align-items:center; justify-content:space-between; margin-bottom:10px; color:#3b4758 }
    .cam-stop{
      padding:.45rem .7rem; border-radius:10px; border:1px solid #d9dee6;
      background:#f7f8fb; cursor:pointer; font-size:.9rem;
    }
    #preview{
      width:100%; max-width:760px; border-radius:12px; background:#000; border:1px solid #e5e8ee;
      display:block;
    }
    #status{ margin-top:10px; font-size:14px; color:#566273 }
    #result{ font-weight:700 }

    #book{ display:none; margin-top:16px; gap:14px; align-items:flex-start }
    #book img{ max-height:140px; border:1px solid #eee; border-radius:12px; background:#fff }
    #book .meta{ display:flex; flex-direction:column; gap:6px }
    #title{ color:var(--ink); font-weight:700 }
    #authors{ color:var(--muted) }

    footer{ margin:40px 0 24px; color:var(--muted); font-size:13px }

    /* å®Œäº†ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ */
    #doneOverlay{ display:none; position:fixed; inset:0; background:rgba(5,12,22,.45); z-index:9999; align-items:center; justify-content:center; padding:20px; }
    .doneCard{
      background:#fff; border-radius:20px; max-width:520px; width:min(92vw,520px);
      padding:22px; box-shadow:var(--shadow-lg); text-align:left;
    }
    .doneCard h2{ margin:0 0 6px; color:var(--ink) }
    .doneCard p{ margin:0 0 10px; color:#4f5b66 }
    .actions{ display:flex; gap:10px; flex-wrap:wrap; margin-top:12px }
    .ghostBtn, .solidBtn, .plainBtn{
      padding:.65rem .95rem; border-radius:12px; font-size:14px; cursor:pointer; border:1px solid transparent; text-decoration:none; display:inline-flex; align-items:center; justify-content:center;
    }
    .solidBtn{ background:#eaf9f0; border-color:#39a66a; color:#216c3e }
    .ghostBtn{ background:#f5f7fb; border-color:#cfd6df; color:#313e4e }
    .plainBtn{ background:#fff; border-color:#e1e7ef; color:#3b4758 }
  </style>
</head>
<body>

  <!-- ãƒ˜ãƒƒãƒ€ -->
  <header>
    <div class="brand">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
           stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
        <path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"/>
        <path d="M20 22H6.5A2.5 2.5 0 0 1 4 19.5V5.5A2.5 2.5 0 0 1 6.5 3H20v19z"/>
      </svg>
      <h1>Lab Library</h1>
    </div>
    <div class="subtitle">ç ”ç©¶å®¤å›³æ›¸ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ </div>
    <div class="underline"></div>
  </header>

  <!-- å…¥åŠ›ã‚«ãƒ¼ãƒ‰ -->
  <main class="card">
    <h2>æœ¬ã®è²¸å‡ºãƒ»è¿”å´</h2>

    <div class="field">
      <label class="label" for="yourName">ãŠåå‰</label>
      <input id="yourName" type="text" placeholder="åå‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„">
    </div>

    <button id="start" class="btn" aria-label="ã‚«ãƒ¡ãƒ©ã‚’èµ·å‹•ã—ã¦ã‚¹ã‚­ãƒ£ãƒ³">
      <svg viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
        <path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V9a2 2 0 0 1 2-2h3l2-3h8l2 3h3a2 2 0 0 1 2 2z"/>
        <circle cx="12" cy="13" r="4"/>
      </svg>
      ã‚«ãƒ¡ãƒ©ã‚’èµ·å‹•ã—ã¦ã‚¹ã‚­ãƒ£ãƒ³
    </button>

    <div class="note">
      <span class="dot"></span>
      <span>åå‰ã‚’å…¥åŠ›ã—ã¦ã‹ã‚‰ã‚«ãƒ¡ãƒ©ã‚’èµ·å‹•ã—ã¦ãã ã•ã„</span>
    </div>
  </main>

  <!-- ã‚«ãƒ¡ãƒ©è¡¨ç¤ºãƒ‘ãƒãƒ«ï¼ˆã‚µã‚¤ãƒˆå†…ã§é–‹ãï¼‰ -->
  <section id="cameraPanel" class="cam-card" style="display:none">
    <div class="cam-head">
      <strong>ã‚«ãƒ¡ãƒ©ã‚’ã‚¹ã‚­ãƒ£ãƒ³ä¸­â€¦</strong>
      <button id="stopBtn" class="cam-stop">åœæ­¢</button>
    </div>
    <video id="preview" playsinline muted></video>
    <div id="status">æœªèµ·å‹•</div>
    <div style="margin-top:6px;">æ¤œå‡ºçµæœ: <span id="result">â€”</span></div>

    <!-- ä»»æ„ï¼šèª­ã¿å–ã£ãŸæœ¬ã®æƒ…å ±ã‚’è¡¨ç¤º -->
    <div id="book">
      <img id="cover" alt="cover">
      <div class="meta">
        <div id="title"></div>
        <div id="authors"></div>
        <div id="rec"></div>
      </div>
    </div>
  </section>

  <footer>
    <small>Â© 2025 Lab Library System</small>
  </footer>

  <!-- å®Œäº†ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ -->
  <div id="doneOverlay">
    <div class="doneCard">
      <h2>âœ… é€ä¿¡å®Œäº†ï¼</h2>
      <p>Slackã® <span id="slackChannelHint" style="font-weight:700; color:var(--brand)">#bookshelf_library</span> ã‚’ç¢ºèªã—ã¦ã­ã€‚</p>
      <p style="margin-bottom:14px;">è¿”å´æ™‚ã«ã¯ <b>ğŸ”š</b> ã‚’ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã«æŠ¼ã—ã¦ãã ã•ã„ã€‚</p>
      <div class="actions">
        <a id="openSlackBtn" href="#" target="_blank" rel="noopener" class="ghostBtn">Slackã‚’é–‹ã</a>
        <button id="scanAgainBtn" class="solidBtn">ç¶šã‘ã¦ã‚¹ã‚­ãƒ£ãƒ³</button>
        <button id="closeDoneBtn" class="plainBtn">é–‰ã˜ã‚‹</button>
      </div>
    </div>
  </div>

  <!-- æ©Ÿèƒ½ã‚¹ã‚¯ãƒªãƒ—ãƒˆ -->
  <script type="module">
    import { BrowserMultiFormatReader, NotFoundException } from "https://cdn.jsdelivr.net/npm/@zxing/library@0.20.0/+esm";

    // ===== è¨­å®šï¼ˆã‚ãªãŸã®URLã‚’ä½¿ç”¨ï¼‰ =====
    const N8N_WEBHOOK_URL = "https://yn8n.app.n8n.cloud/webhook/87e99525-d98d-4ca5-94c5-c1440d4b5ebd";
    const SLACK_TARGET_URL = ""; // ä¾‹: "https://app.slack.com/client/TXXXX/CYYYYY"
    const SLACK_CHANNEL_LABEL = "#bookshelf_library";

    // è¦ç´ å‚ç…§
    const codeReader = new BrowserMultiFormatReader();
    const startBtn    = document.getElementById('start');
    const stopBtn     = document.getElementById('stopBtn');
    const cameraPanel = document.getElementById('cameraPanel');
    const video       = document.getElementById('preview');
    const statusEl    = document.getElementById('status');
    const nameEl      = document.getElementById('yourName');
    const resultEl    = document.getElementById('result');
    const bookBox     = document.getElementById('book');
    const coverEl     = document.getElementById('cover');
    const titleEl     = document.getElementById('title');
    const authorsEl   = document.getElementById('authors');
    const recEl       = document.getElementById('rec');

    let lastScan = { code: null, at: 0 };
    let sending  = false;

    // ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£
    function isValidIsbn13(s){
      if(!/^\d{13}$/.test(s)) return false;
      const a = s.split('').map(Number);
      const sum = a.slice(0,12).reduce((acc,d,i)=> acc + d * (i%2?3:1), 0);
      return (10 - (sum % 10)) % 10 === a[12];
    }
    function normalizeCandidate(raw){
      let t = (raw||'').replace(/\D/g,'');
      if (t.length > 13 && t.startsWith('97') && /^\d{18}$/.test(t)) t = t.slice(0,13);
      return t;
    }
    function looksLikeIsbn13(s){ return (s.startsWith('978') || s.startsWith('979')) && isValidIsbn13(s); }
    function debounceDuplicate(code, ms=3000){
      const now = Date.now();
      if (lastScan.code === code && (now - lastScan.at) < ms) return true;
      lastScan = { code, at: now }; return false;
    }

    // ã‚«ãƒ¡ãƒ©é–‹å§‹ï¼ˆã‚µã‚¤ãƒˆå†…ã§é–‹ãï¼‰
    async function startCamera(){
      if (!nameEl.value.trim()){ alert("å…ˆã«ãŠåå‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„"); return; }
      statusEl.textContent = "ã‚¹ã‚­ãƒ£ãƒ³ä¸­â€¦";
      cameraPanel.style.display = "block";
      try {
        codeReader.decodeFromVideoDevice(null, video, onScan);
      } catch (e) {
        console.error(e); statusEl.textContent = "èµ·å‹•ã‚¨ãƒ©ãƒ¼: " + e.message;
      }
    }

    // ã‚«ãƒ¡ãƒ©åœæ­¢ï¼ˆãƒ‘ãƒãƒ«ã‚’é–‰ã˜ã‚‹ï¼‰
    function stopCamera(){
      try { codeReader.reset(); } catch(e){}
      if (video && video.srcObject) {
        video.srcObject.getVideoTracks().forEach(t => t.stop());
        video.srcObject = null;
      }
      statusEl.textContent = "åœæ­¢ä¸­";
      cameraPanel.style.display = "none";
    }

    // ã‚¹ã‚­ãƒ£ãƒ³æ™‚ã®å‡¦ç†
    async function onScan(res, err){
      if(res){
        const raw  = res.getText();
        const cand = normalizeCandidate(raw);
        if (!looksLikeIsbn13(cand)) return;
        if (debounceDuplicate(cand)) return;

        stopCamera(); // ãƒ’ãƒƒãƒˆã—ãŸç¬é–“ã«åœæ­¢ï¼ˆå¤šé‡é€ä¿¡é˜²æ­¢ï¼‰
        resultEl.textContent = cand;

        if (sending) return; sending = true;
        const payload = { isbn: cand, name: nameEl.value.trim() };

        try{
          const r = await fetch(N8N_WEBHOOK_URL, {
            method:"POST",
            headers:{ "Content-Type":"application/json" },
            body: JSON.stringify(payload)
          });
          if(!r.ok) throw new Error("n8n error " + r.status);
          const data = await r.json().catch(()=> ({}));

          if (data && data.book){
            bookBox.style.display = "flex";
            coverEl.src = data.book.cover_url || "";
            titleEl.textContent = `${data.book.title || "ã‚¿ã‚¤ãƒˆãƒ«ä¸æ˜"} / ${data.book.isbn13 || ""}`;
            authorsEl.textContent = (data.book.authors || []).join(", ");
            recEl.textContent = "";
          }
          statusEl.textContent = "é€ä¿¡å®Œäº†ï¼ˆã‚«ãƒ¡ãƒ©ã¯åœæ­¢ä¸­ï¼‰";
          showDoneCard();
        }catch(e){
          console.error(e);
          statusEl.textContent = "é€ä¿¡å¤±æ•—: " + e.message;
        } finally {
          sending = false;
        }
      } else if (err && !(err instanceof NotFoundException)) {
        console.warn(err);
      }
    }

    // ãƒœã‚¿ãƒ³
    startBtn.addEventListener('click', startCamera);
    stopBtn.addEventListener('click', stopCamera);

    // HTTPSæ³¨æ„
    if (location.protocol !== 'https:' && location.hostname !== 'localhost') {
      statusEl.textContent = "æ³¨æ„: ã‚«ãƒ¡ãƒ©ä½¿ç”¨ã«ã¯ https ãŒå¿…è¦ã§ã™ï¼ˆlocalhosté™¤ãï¼‰";
    }

    // å®Œäº†ã‚«ãƒ¼ãƒ‰
    function showDoneCard(){
      const ov = document.getElementById('doneOverlay');
      const openSlackBtn = document.getElementById('openSlackBtn');
      const slackHint = document.getElementById('slackChannelHint');
      slackHint.textContent = SLACK_CHANNEL_LABEL || "Slack";
      if (SLACK_TARGET_URL) { openSlackBtn.href = SLACK_TARGET_URL; openSlackBtn.style.display = 'inline-flex'; }
      else { openSlackBtn.style.display = 'none'; }
      ov.style.display = 'flex';
    }
    function hideDoneCard(){ document.getElementById('doneOverlay').style.display = 'none'; }
    document.getElementById('scanAgainBtn').addEventListener('click', ()=>{ hideDoneCard(); startCamera(); });
    document.getElementById('closeDoneBtn').addEventListener('click', hideDoneCard);
  </script>
</body>
</html>
