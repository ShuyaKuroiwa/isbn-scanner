<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Lab Library｜ISBNスキャナ</title>
  <style>
    :root{
      --brand:#d33a57;
      --brand-weak:#e8728b;
      --ink:#2f3a4a;
      --text:#5a6473;
      --muted:#7b8794;
      --panel:#fdeaf0;
      --bg:#fbfcfe;
      --radius-xl:24px;
      --shadow-lg:0 24px 64px rgba(27,39,51,.14);
      --shadow-md:0 12px 32px rgba(27,39,51,.10);
      --ring: 0 0 0 3px rgba(211,58,87,.18), 0 1px 2px rgba(0,0,0,.06) inset;
    }

    /* ===== ページ全体 ===== */
    html,body{height:100%}
    body{
      margin:0; color:var(--text);
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Hiragino Sans", "Noto Sans JP", "Yu Gothic UI", "Yu Gothic", "游ゴシック", "Meiryo", sans-serif;
      background:
        radial-gradient(1200px 600px at 20% -10%, #ffeef4 0%, rgba(255,255,255,0) 60%),
        radial-gradient(1000px 500px at 90% 0%, #eef5ff 0%, rgba(255,255,255,0) 55%),
        var(--bg);
      display:flex; flex-direction:column; align-items:center;
    }

    /* ===== ヘッダ ===== */
    header{ width:min(920px, 92vw); text-align:center; margin:48px 0 28px; }
    .brand{ display:inline-flex; align-items:center; gap:14px; color:var(--ink); }
    .brand svg{ width:36px; height:36px; color:var(--brand); }
    .brand h1{ font-size:clamp(28px,4.4vw,44px); line-height:1.1; margin:0; letter-spacing:.4px; font-weight:800; }
    .subtitle{ margin-top:8px; color:var(--text); font-size:clamp(14px,1.8vw,18px); }
    .underline{ width:120px; height:6px; margin:20px auto 0; border-radius:999px; background:var(--brand); opacity:.88; }

    /* ===== 入力カード（中央揃え＆きれい） ===== */
    .card{
      width:min(740px, 92vw);
      margin:28px auto 0;
      background:var(--panel);
      border-radius:var(--radius-xl);
      box-shadow:var(--shadow-lg);
      padding:28px clamp(18px, 5vw, 40px);
    }
    .card h2{ margin:6px 0 18px; text-align:center; color:var(--ink); font-size:clamp(18px,3vw,24px); letter-spacing:.6px; }

    .formRow{
      max-width:560px; margin:0 auto;           /* ← フォーム一式を中央に固定幅 */
      display:flex; flex-direction:column; gap:14px;
      align-items:stretch;
    }
    .label{ font-weight:800; color:var(--ink); }
    input[type="text"]{
      width:100%;
      background:#fff; border:1px solid #e6e8eb; border-radius:14px;
      padding:16px 18px; font-size:18px; outline:none;
      text-align:center;                         /* ← テキストも中央揃え */
      box-shadow: inset 0 1px 0 rgba(0,0,0,.02);
      transition: box-shadow .15s ease, border-color .15s ease;
    }
    input[type="text"]::placeholder{ color:#9aa5b1 }
    input[type="text"]:focus{ border-color:#f2b5c1; box-shadow:var(--ring) }

    .btn{
      width:100%; display:inline-flex; align-items:center; justify-content:center; gap:10px;
      margin-top:4px; padding:16px 18px; background:var(--brand-weak); color:#fff;
      border:none; border-radius:16px; font-size:18px; letter-spacing:.6px; cursor:pointer;
      box-shadow:var(--shadow-md); transition: transform .03s ease, filter .2s ease, background .2s ease;
    }
    .btn:hover{ filter:brightness(1.03) }
    .btn:active{ transform:translateY(1px) }
    .btn svg{ width:20px; height:20px }

    .note{ margin:6px auto 0; color:var(--muted); display:flex; align-items:flex-start; gap:8px; font-size:14px; max-width:560px; }
    .note .dot{ width:8px; height:8px; border-radius:999px; background:var(--brand); margin-top:7px }

    /* ===== カメラパネル ===== */
    .cam-card{
      width:min(860px, 92vw);
      margin:18px auto 0;
      background:#fff; border-radius:16px; box-shadow:var(--shadow-md);
      padding:14px 14px 18px; border:1px solid #e9edf3; display:none;
    }
    .cam-head{ display:flex; align-items:center; justify-content:space-between; margin-bottom:10px; color:#3b4758 }
    .cam-stop{
      padding:.45rem .7rem; border-radius:10px; border:1px solid #d9dee6;
      background:#f7f8fb; cursor:pointer; font-size:.9rem;
    }
    #preview{
      width:100%; max-width:760px; border-radius:12px; background:#000; border:1px solid #e5e8ee;
      display:block;
    }
    #status{ margin-top:10px; font-size:14px; color:#566273; text-align:center }
    #result{ font-weight:800 }

    /* 本プレビュー（任意） */
    #book{ display:none; margin-top:16px; gap:14px; align-items:flex-start }
    #book img{ max-height:140px; border:1px solid #eee; border-radius:12px; background:#fff }
    #book .meta{ display:flex; flex-direction:column; gap:6px }
    #title{ color:var(--ink); font-weight:800 }
    #authors{ color:var(--muted) }

    footer{ margin:40px 0 24px; color:var(--muted); font-size:13px }

    /* ===== 完了オーバーレイ ===== */
    #doneOverlay{ display:none; position:fixed; inset:0; background:rgba(5,12,22,.45); z-index:9999; align-items:center; justify-content:center; padding:20px; }
    .doneCard{
      background:#fff; border-radius:20px; max-width:520px; width:min(92vw,520px);
      padding:22px; box-shadow:var(--shadow-lg); text-align:left;
    }
    .doneCard h2{ margin:0 0 6px; color:var(--ink) }
    .doneCard p{ margin:0 0 10px; color:#4f5b66 }
    .actions{ display:flex; gap:10px; flex-wrap:wrap; margin-top:12px }
    .ghostBtn, .solidBtn, .plainBtn{
      padding:.65rem .95rem; border-radius:12px; font-size:14px; cursor:pointer; border:1px solid transparent; text-decoration:none; display:inline-flex; align-items:center; justify-content:center;
    }
    .solidBtn{ background:#eaf9f0; border-color:#39a66a; color:#216c3e }
    .ghostBtn{ background:#f5f7fb; border-color:#cfd6df; color:#313e4e }
    .plainBtn{ background:#fff; border-color:#e1e7ef; color:#3b4758 }

    /* ===== ローディング（スキャン後～応答待ち） ===== */
    #loadingOverlay{
      display:none; position:fixed; inset:0; z-index:9998;
      background:rgba(255,255,255,.8); backdrop-filter:saturate(140%) blur(2px);
      align-items:center; justify-content:center;
    }
    .spinner{
      width:56px; height:56px; border-radius:50%;
      border:4px solid rgba(211,58,87,.18); border-top-color: var(--brand);
      animation: spin 1s linear infinite;
      margin:0 auto 10px;
    }
    @keyframes spin{ to{ transform: rotate(360deg); } }
    .loadingText{ color:var(--ink); font-weight:700; letter-spacing:.2px }
  </style>
</head>
<body>

  <!-- ヘッダ -->
  <header>
    <div class="brand">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
           stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
        <path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"/>
        <path d="M20 22H6.5A2.5 2.5 0 0 1 4 19.5V5.5A2.5 2.5 0 0 1 6.5 3H20v19z"/>
      </svg>
      <h1>Lab Library</h1>
    </div>
    <div class="subtitle">研究室図書管理システム</div>
    <div class="underline"></div>
  </header>

  <!-- 入力カード（中央寄せフォーム） -->
  <main class="card">
    <h2>本の貸出・返却</h2>

    <div class="formRow">
      <label class="label" for="yourName">お名前</label>
      <input id="yourName" type="text" placeholder="名前を入力してください">

      <button id="start" class="btn" aria-label="カメラを起動してスキャン">
        <svg viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
          <path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V9a2 2 0 0 1 2-2h3l2-3h8l2 3h3a2 2 0 0 1 2 2z"/>
          <circle cx="12" cy="13" r="4"/>
        </svg>
        カメラを起動してスキャン
      </button>

      <div class="note">
        <span class="dot"></span>
        <span>名前を入力してからカメラを起動してください</span>
      </div>
    </div>
  </main>

  <!-- カメラ表示パネル（サイト内で開く） -->
  <section id="cameraPanel" class="cam-card">
    <div class="cam-head">
      <strong>カメラをスキャン中…</strong>
      <button id="stopBtn" class="cam-stop">停止</button>
    </div>
    <video id="preview" playsinline muted></video>
    <div id="status">未起動</div>
    <div style="margin-top:6px; text-align:center;">検出結果: <span id="result">—</span></div>

    <!-- 任意：読み取った本の情報 -->
    <div id="book">
      <img id="cover" alt="cover">
      <div class="meta">
        <div id="title"></div>
        <div id="authors"></div>
        <div id="rec"></div>
      </div>
    </div>
  </section>

  <footer>
    <small>© 2025 Lab Library System</small>
  </footer>

  <!-- 完了オーバーレイ -->
  <div id="doneOverlay">
    <div class="doneCard">
      <h2>✅ 送信完了！</h2>
      <p>Slackの <span id="slackChannelHint" style="font-weight:700; color:var(--brand)">#bookshelf_library</span> を確認してね。</p>
      <p style="margin-bottom:14px;">返却時には <b>「end」スタンプ</b> をメッセージに押してください。</p>
      <div class="actions">
        <a id="openSlackBtn" href="#" target="_blank" rel="noopener" class="ghostBtn">Slackを開く</a>
        <button id="scanAgainBtn" class="solidBtn">続けてスキャン</button>
        <button id="closeDoneBtn" class="plainBtn">閉じる</button>
      </div>
    </div>
  </div>

  <!-- ローディング（スキャン後～応答待ち） -->
  <div id="loadingOverlay">
    <div style="text-align:center;">
      <div class="spinner"></div>
      <div class="loadingText">読み込み中…</div>
    </div>
  </div>

  <!-- 機能スクリプト -->
  <script type="module">
    import { BrowserMultiFormatReader, NotFoundException } from "https://cdn.jsdelivr.net/npm/@zxing/library@0.20.0/+esm";

    // ===== 設定（あなたのURLを使用） =====
    const N8N_WEBHOOK_URL = "https://yn8n.app.n8n.cloud/webhook/87e99525-d98d-4ca5-94c5-c1440d4b5ebd";
    const SLACK_TARGET_URL = ""; // 例: "https://app.slack.com/client/TXXXX/CYYYYY"
    const SLACK_CHANNEL_LABEL = "#bookshelf_library";

    // 要素参照
    const codeReader = new BrowserMultiFormatReader();
    const startBtn    = document.getElementById('start');
    const stopBtn     = document.getElementById('stopBtn');
    const cameraPanel = document.getElementById('cameraPanel');
    const video       = document.getElementById('preview');
    const statusEl    = document.getElementById('status');
    const nameEl      = document.getElementById('yourName');
    const resultEl    = document.getElementById('result');
    const bookBox     = document.getElementById('book');
    const coverEl     = document.getElementById('cover');
    const titleEl     = document.getElementById('title');
    const authorsEl   = document.getElementById('authors');
    const recEl       = document.getElementById('rec');

    const loadingOv   = document.getElementById('loadingOverlay');

    let lastScan = { code: null, at: 0 };
    let sending  = false;

    // ユーティリティ
    function isValidIsbn13(s){
      if(!/^\d{13}$/.test(s)) return false;
      const a = s.split('').map(Number);
      const sum = a.slice(0,12).reduce((acc,d,i)=> acc + d * (i%2?3:1), 0);
      return (10 - (sum % 10)) % 10 === a[12];
    }
    function normalizeCandidate(raw){
      let t = (raw||'').replace(/\D/g,'');
      if (t.length > 13 && t.startsWith('97') && /^\d{18}$/.test(t)) t = t.slice(0,13);
      return t;
    }
    function looksLikeIsbn13(s){ return (s.startsWith('978') || s.startsWith('979')) && isValidIsbn13(s); }
    function debounceDuplicate(code, ms=3000){
      const now = Date.now();
      if (lastScan.code === code && (now - lastScan.at) < ms) return true;
      lastScan = { code, at: now }; return false;
    }

    // カメラ開始（サイト内で開く）
    function startCamera(){
      if (!nameEl.value.trim()){ alert("先にお名前を入力してください"); return; }
      statusEl.textContent = "スキャン中…";
      cameraPanel.style.display = "block";
      try {
        codeReader.decodeFromVideoDevice(null, video, onScan);
      } catch (e) {
        console.error(e); statusEl.textContent = "起動エラー: " + e.message;
      }
    }

    // カメラ停止（パネルを閉じる）
    function stopCamera(){
      try { codeReader.reset(); } catch(e){}
      if (video && video.srcObject) {
        video.srcObject.getVideoTracks().forEach(t => t.stop());
        video.srcObject = null;
      }
      statusEl.textContent = "停止中";
      cameraPanel.style.display = "none";
    }

    // スキャン時の処理
    async function onScan(res, err){
      if(res){
        const raw  = res.getText();
        const cand = normalizeCandidate(raw);
        if (!looksLikeIsbn13(cand)) return;
        if (debounceDuplicate(cand)) return;

        stopCamera(); // ヒットした瞬間に停止（多重送信防止）
        resultEl.textContent = cand;

        if (sending) return; sending = true;

        // ← ローディング開始
        loadingOv.style.display = 'flex';

        const payload = { isbn: cand, name: nameEl.value.trim() };

        try{
          const r = await fetch(N8N_WEBHOOK_URL, {
            method:"POST",
            headers:{ "Content-Type":"application/json" },
            body: JSON.stringify(payload)
          });
          if(!r.ok) throw new Error("n8n error " + r.status);
          const data = await r.json().catch(()=> ({}));

          if (data && data.book){
            bookBox.style.display = "flex";
            coverEl.src = data.book.cover_url || "";
            titleEl.textContent = `${data.book.title || "タイトル不明"} / ${data.book.isbn13 || ""}`;
            authorsEl.textContent = (data.book.authors || []).join(", ");
            recEl.textContent = "";
          }
          statusEl.textContent = "送信完了（カメラは停止中）";
          showDoneCard();
        }catch(e){
          console.error(e);
          statusEl.textContent = "送信失敗: " + e.message;
          alert("通信に失敗しました。ネットワーク状況を確認してください。");
        } finally {
          sending = false;
          // ← ローディング終了
          loadingOv.style.display = 'none';
        }
      } else if (err && !(err instanceof NotFoundException)) {
        console.warn(err);
      }
    }

    // ボタン
    document.getElementById('start').addEventListener('click', startCamera);
    document.getElementById('stopBtn').addEventListener('click', stopCamera);

    // HTTPS注意
    if (location.protocol !== 'https:' && location.hostname !== 'localhost') {
      statusEl.textContent = "注意: カメラ使用には https が必要です（localhost除く）";
    }

    // 完了カード
    function showDoneCard(){
      const ov = document.getElementById('doneOverlay');
      const openSlackBtn = document.getElementById('openSlackBtn');
      const slackHint = document.getElementById('slackChannelHint');
      slackHint.textContent = SLACK_CHANNEL_LABEL || "Slack";
      if (SLACK_TARGET_URL) { openSlackBtn.href = SLACK_TARGET_URL; openSlackBtn.style.display = 'inline-flex'; }
      else { openSlackBtn.style.display = 'none'; }
      ov.style.display = 'flex';
    }
    function hideDoneCard(){ document.getElementById('doneOverlay').style.display = 'none'; }
    document.getElementById('scanAgainBtn').addEventListener('click', ()=>{ hideDoneCard(); startCamera(); });
    document.getElementById('closeDoneBtn').addEventListener('click', hideDoneCard);
  </script>
</body>
</html>
