<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Lab Library｜ISBNスキャナ</title>
  <style>
    :root{
      --brand:#d33a57;
      --brand-weak:#e8728b;
      --ink:#2f3a4a;
      --text:#5a6473;
      --muted:#7b8794;
      --panel:#fdeaf0;
      --bg:#fbfcfe;
      --radius-xl:24px;
      --shadow-lg:0 24px 64px rgba(27,39,51,.14);
      --shadow-md:0 12px 32px rgba(27,39,51,.10);
    }

    body{
      margin:0; color:var(--text);
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Hiragino Sans", "Noto Sans JP", "Yu Gothic UI", "Yu Gothic", "游ゴシック", "Meiryo", sans-serif;
      background: var(--bg);
      display:flex; flex-direction:column; align-items:center;
    }
    header{ text-align:center; margin:40px 0 20px; }
    .brand{ display:inline-flex; align-items:center; gap:12px; color:var(--ink); }
    .brand h1{ font-size:28px; margin:0; font-weight:800; }
    .subtitle{ margin-top:6px; color:var(--text); }

    .card{
      width:min(720px, 92vw);
      background:var(--panel);
      border-radius:var(--radius-xl);
      box-shadow:var(--shadow-lg);
      padding:28px;
    }
    .card h2{ text-align:center; margin:0 0 16px; color:var(--ink) }
    .formRow{ display:flex; flex-direction:column; gap:14px; max-width:480px; margin:0 auto; }
    label{ font-weight:700; color:var(--ink); }
    input[type="text"]{
      padding:14px; border:1px solid #ddd; border-radius:12px;
      font-size:16px; text-align:center;
    }
    .btn{
      padding:14px; border:none; border-radius:12px;
      background:var(--brand-weak); color:white; font-size:16px;
      cursor:pointer; font-weight:600;
    }
    .btn:hover{ filter:brightness(1.05); }
    .note{ font-size:14px; color:var(--muted); text-align:center }

    /* カメラプレビューを同じカードに */
    #cameraBox{
      margin-top:20px; display:none; flex-direction:column; align-items:center; gap:10px;
    }
    video{
      width:100%; max-width:560px; border-radius:12px; background:#000;
    }
    #status{ font-size:14px; color:#555; }
    #result{ font-weight:700; }

    /* ローディング */
    #loadingOverlay{
      display:none; position:fixed; inset:0; background:rgba(255,255,255,.8);
      align-items:center; justify-content:center; z-index:999;
    }
    .spinner{ width:50px; height:50px; border:5px solid rgba(0,0,0,.1); border-top-color:var(--brand); border-radius:50%; animation:spin 1s linear infinite; }
    @keyframes spin{ to{ transform:rotate(360deg) } }
  </style>
</head>
<body>
  <header>
    <div class="brand"><h1>Lab Library</h1></div>
    <div class="subtitle">研究室図書管理システム</div>
  </header>

  <main class="card">
    <h2>本の貸出・返却</h2>
    <div class="formRow">
      <label for="yourName">お名前</label>
      <input id="yourName" type="text" placeholder="名前を入力してください">
      <button id="start" class="btn">📷 カメラを起動してスキャン</button>
      <div class="note">名前を入力してからカメラを起動してください</div>
    </div>

    <!-- カメラプレビューエリア -->
    <div id="cameraBox">
      <video id="preview" playsinline muted></video>
      <div id="status">未起動</div>
      <div>検出結果: <span id="result">—</span></div>
    </div>
  </main>

  <!-- ローディング -->
  <div id="loadingOverlay"><div class="spinner"></div></div>

  <script type="module">
    import { BrowserMultiFormatReader, NotFoundException } from "https://cdn.jsdelivr.net/npm/@zxing/library@0.20.0/+esm";

    const N8N_WEBHOOK_URL = "https://yn8n.app.n8n.cloud/webhook/87e99525-d98d-4ca5-94c5-c1440d4b5ebd";

    const codeReader = new BrowserMultiFormatReader();
    const startBtn = document.getElementById('start');
    const nameEl = document.getElementById('yourName');
    const cameraBox = document.getElementById('cameraBox');
    const video = document.getElementById('preview');
    const statusEl = document.getElementById('status');
    const resultEl = document.getElementById('result');
    const loadingOv = document.getElementById('loadingOverlay');

    let lastScan = { code: null, at: 0 };
    let sending = false;

    function isValidIsbn13(s){
      if(!/^\d{13}$/.test(s)) return false;
      const a = s.split('').map(Number);
      const sum = a.slice(0,12).reduce((acc,d,i)=> acc + d*(i%2?3:1), 0);
      return (10 - (sum % 10)) % 10 === a[12];
    }
    function normalizeCandidate(raw){ return (raw||'').replace(/\D/g,'').slice(0,13); }
    function looksLikeIsbn13(s){ return (s.startsWith('978')||s.startsWith('979')) && isValidIsbn13(s); }
    function debounceDuplicate(code,ms=3000){
      const now=Date.now(); if(lastScan.code===code && (now-lastScan.at)<ms) return true;
      lastScan={code,at:now}; return false;
    }

    function startCamera(){
      if (!nameEl.value.trim()){ alert("名前を入力してください"); return; }
      cameraBox.style.display="flex";
      statusEl.textContent="スキャン中…";
      codeReader.decodeFromVideoDevice(null, video, onScan);
    }
    function stopCamera(){
      try{ codeReader.reset(); }catch(e){}
      if(video.srcObject){ video.srcObject.getTracks().forEach(t=>t.stop()); video.srcObject=null; }
      statusEl.textContent="停止中";
    }

    async function onScan(res, err){
      if(res){
        const cand = normalizeCandidate(res.getText());
        if (!looksLikeIsbn13(cand)) return;
        if (debounceDuplicate(cand)) return;
        stopCamera();
        resultEl.textContent=cand;
        if(sending) return; sending=true;
        loadingOv.style.display="flex";

        try{
          await fetch(N8N_WEBHOOK_URL,{
            method:"POST",
            headers:{"Content-Type":"application/json"},
            body:JSON.stringify({isbn:cand,name:nameEl.value.trim()})
          });
          statusEl.textContent="送信完了";
        }catch(e){
          console.error(e); statusEl.textContent="送信失敗";
        }finally{
          sending=false; loadingOv.style.display="none";
        }
      } else if(err && !(err instanceof NotFoundException)){
        console.warn(err);
      }
    }

    startBtn.addEventListener('click', startCamera);
  </script>
</body>
</html>
